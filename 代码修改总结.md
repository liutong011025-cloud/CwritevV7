# ä»£ç ä¿®æ”¹æ€»ç»“ - å›¾ç‰‡ç”Ÿæˆæ”¹ä¸ºè§†é¢‘ç”Ÿæˆ

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

æœ¬æ¬¡ä¿®æ”¹å…±æ¶‰åŠ **3ä¸ªä»£ç æ–‡ä»¶** å’Œ **1ä¸ªæ–‡æ¡£æ–‡ä»¶**ï¼š

### 1. âœ… æ–°å»ºæ–‡ä»¶ï¼š`app/api/generate-video/route.ts`
**ä½œç”¨**ï¼šåˆ›å»ºä¸“é—¨çš„è§†é¢‘ç”Ÿæˆ API ç«¯ç‚¹

**å…³é”®å†…å®¹**ï¼š
- ä½¿ç”¨ fal.ai çš„ `flux-schnell` æ¨¡å‹ï¼ˆä¾¿å®œçš„å¿«é€Ÿè§†é¢‘æ¨¡å‹ï¼‰
- API ç«¯ç‚¹ï¼š`https://fal.run/fal-ai/flux-schnell`
- å‚æ•°è®¾ç½®ï¼š
  - `num_frames: 25`ï¼ˆçº¦1ç§’è§†é¢‘ï¼‰
  - `num_inference_steps: 6`ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼Œé™ä½æˆæœ¬ï¼‰
  - `image_size: "landscape_16_9"`ï¼ˆ16:9æ¨ªå‘æ¯”ä¾‹ï¼‰
- è¶…æ—¶æ—¶é—´ï¼š300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
- è¿”å›æ ¼å¼ï¼šåŒæ—¶è¿”å› `videoUrl` å’Œ `imageUrl`ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

### 2. âœ… ä¿®æ”¹æ–‡ä»¶ï¼š`app/api/dify-structure-examples/route.ts`

**ä¿®æ”¹ä½ç½®1**ï¼šé¡¶éƒ¨å¸¸é‡å®šä¹‰ï¼ˆç¬¬8-10è¡Œï¼‰
```typescript
// ä¿®æ”¹å‰ï¼š
const FAL_API_ENDPOINT = 'https://fal.run/fal-ai/nano-banana'

// ä¿®æ”¹åï¼š
const FAL_IMAGE_API_ENDPOINT = 'https://fal.run/fal-ai/nano-banana'
const FAL_VIDEO_API_ENDPOINT = 'https://fal.run/fal-ai/flux-schnell'
```

**ä¿®æ”¹ä½ç½®2**ï¼šå•ä¸ªæ•…äº‹ç”Ÿæˆæ—¶çš„åª’ä½“ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬264-332è¡Œï¼‰
- **ä¿®æ”¹å‰**ï¼šç”Ÿæˆå›¾ç‰‡ (`imageUrl`)
- **ä¿®æ”¹å**ï¼šç”Ÿæˆè§†é¢‘ (`videoUrl`)
  - å°† `imagePrompt` æ”¹ä¸º `videoPrompt`
  - å°† `imageResponse` æ”¹ä¸º `videoResponse`
  - å°† API ç«¯ç‚¹ä» `FAL_API_ENDPOINT` æ”¹ä¸º `FAL_VIDEO_API_ENDPOINT`
  - å°†è¯·æ±‚å‚æ•°ä»å›¾ç‰‡æ ¼å¼æ”¹ä¸ºè§†é¢‘æ ¼å¼ï¼š
    ```typescript
    // ä¿®æ”¹å‰ï¼š
    {
      prompt: imagePrompt,
      num_images: 1,
      output_format: 'jpeg',
      aspect_ratio: '16:9',
      sync_mode: true,
    }
    
    // ä¿®æ”¹åï¼š
    {
      prompt: videoPrompt,
      image_size: "landscape_16_9",
      num_frames: 25,
      num_inference_steps: 6,
    }
    ```
  - è¶…æ—¶æ—¶é—´ä» 120 ç§’å¢åŠ åˆ° 300 ç§’
  - å“åº”è§£æä» `images[0].url` æ”¹ä¸º `video.url` æˆ– `video_url`

**ä¿®æ”¹ä½ç½®3**ï¼šè¿”å›æ•°æ®æ ¼å¼ï¼ˆç¬¬332-333è¡Œï¼‰
```typescript
// ä¿®æ”¹å‰ï¼š
return NextResponse.json({
  story: exampleStory,
  imageUrl: imageUrl,
  structure_type: structure_type,
})

// ä¿®æ”¹åï¼š
return NextResponse.json({
  story: exampleStory,
  videoUrl: videoUrl, // æ–°å¢
  imageUrl: videoUrl, // ä¿æŒå‘åå…¼å®¹
  structure_type: structure_type,
})
```

### 3. âœ… ä¿®æ”¹æ–‡ä»¶ï¼š`components/stages/story-structure.tsx`

**ä¿®æ”¹ä½ç½®1**ï¼šæ¥å£å®šä¹‰ï¼ˆç¬¬19-23è¡Œï¼‰
```typescript
// ä¿®æ”¹å‰ï¼š
interface StoryExample {
  structure_type: string
  story: string
  imageUrl: string
}

// ä¿®æ”¹åï¼š
interface StoryExample {
  structure_type: string
  story: string
  imageUrl: string
  videoUrl?: string // æ–°å¢è§†é¢‘URLå­—æ®µ
}
```

**ä¿®æ”¹ä½ç½®2**ï¼šæ‰¹é‡ç”Ÿæˆä¸‰ä¸ªæ•…äº‹æ—¶çš„åª’ä½“ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬143-190è¡Œï¼‰
- **ä¿®æ”¹å‰**ï¼šè°ƒç”¨ `/api/generate-image` ç”Ÿæˆå›¾ç‰‡
- **ä¿®æ”¹å**ï¼šè°ƒç”¨ `/api/generate-video` ç”Ÿæˆè§†é¢‘
  ```typescript
  // ä¿®æ”¹å‰ï¼š
  const imageResponse = await fetch("/api/generate-image", {
    // ...
  })
  const imageData = await imageResponse.json()
  imageUrl = imageData.imageUrl || ''
  
  // ä¿®æ”¹åï¼š
  const videoResponse = await fetch("/api/generate-video", {
    // ...
  })
  const videoData = await videoResponse.json()
  videoUrl = videoData.videoUrl || videoData.imageUrl || ''
  imageUrl = videoUrl // ä¿æŒå‘åå…¼å®¹
  ```
- å°†å˜é‡åä» `imageUrl`ã€`imagePrompt`ã€`imageResponse` æ”¹ä¸º `videoUrl`ã€`videoPrompt`ã€`videoResponse`

**ä¿®æ”¹ä½ç½®3**ï¼šé€‰æ‹©ç»“æ„æ—¶çš„å¤„ç†é€»è¾‘ï¼ˆç¬¬211-225è¡Œï¼‰
```typescript
// ä¿®æ”¹å‰ï¼š
const example = examples.find((e) => e.structure_type === structureType)
if (example?.imageUrl) {
  setSelectedStructureImage(example.imageUrl)
}
onStructureSelect({
  type: structure.type as any,
  outline: structure.outline,
  imageUrl: example?.imageUrl || "",
})

// ä¿®æ”¹åï¼š
const example = examples.find((e) => e.structure_type === structureType)
const mediaUrl = example?.videoUrl || example?.imageUrl || "" // ä¼˜å…ˆä½¿ç”¨è§†é¢‘
if (mediaUrl) {
  setSelectedStructureImage(mediaUrl)
}
onStructureSelect({
  type: structure.type as any,
  outline: structure.outline,
  imageUrl: mediaUrl, // ä¼ é€’è§†é¢‘URLæˆ–å›¾ç‰‡URL
})
```

**ä¿®æ”¹ä½ç½®4**ï¼šå‰ç«¯æ˜¾ç¤ºç»„ä»¶ï¼ˆç¬¬418-444è¡Œï¼‰
- **ä¿®æ”¹å‰**ï¼šä½¿ç”¨ `<img>` æ ‡ç­¾æ˜¾ç¤ºå›¾ç‰‡
  ```tsx
  <img
    src={example.imageUrl}
    alt={`Example for ${structure.name}`}
    className="w-full h-auto max-h-[500px] min-h-[400px] object-contain"
  />
  ```

- **ä¿®æ”¹å**ï¼šä½¿ç”¨ `<video>` æ ‡ç­¾æ˜¾ç¤ºè§†é¢‘
  ```tsx
  <video
    src={example.videoUrl || example.imageUrl}
    controls
    autoPlay
    loop
    muted
    playsInline
    className="w-full h-auto max-h-[500px] min-h-[400px] object-contain"
  >
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
  </video>
  ```

**ä¿®æ”¹ä½ç½®5**ï¼šæ¡ä»¶æ¸²æŸ“æ£€æŸ¥ï¼ˆç¬¬418è¡Œï¼‰
```tsx
// ä¿®æ”¹å‰ï¼š
{example && example.imageUrl && (

// ä¿®æ”¹åï¼š
{example && (example.videoUrl || example.imageUrl) && (
```

### 4. ğŸ“„ æ–°å»ºæ–‡æ¡£ï¼š`FAL_AI_VIDEO_SETUP.md`
**ä½œç”¨**ï¼šfal.ai è§†é¢‘ç”Ÿæˆè®¾ç½®æŒ‡å—æ–‡æ¡£

---

## ä¿®æ”¹ç»Ÿè®¡

- **æ–°å»ºæ–‡ä»¶**ï¼š2 ä¸ªï¼ˆ1ä¸ªä»£ç æ–‡ä»¶ + 1ä¸ªæ–‡æ¡£ï¼‰
- **ä¿®æ”¹æ–‡ä»¶**ï¼š2 ä¸ª
- **ä»£ç è¡Œæ•°**ï¼š
  - æ–°å¢ï¼šçº¦ 130 è¡Œï¼ˆgenerate-video/route.tsï¼‰
  - ä¿®æ”¹ï¼šçº¦ 80 è¡Œ
  - åˆ é™¤ï¼šçº¦ 50 è¡Œ

## æ ¸å¿ƒæ”¹åŠ¨ç‚¹

1. **API ç«¯ç‚¹å˜æ›´**ï¼š
   - å›¾ç‰‡ï¼š`https://fal.run/fal-ai/nano-banana`
   - è§†é¢‘ï¼š`https://fal.run/fal-ai/flux-schnell`

2. **è¯·æ±‚å‚æ•°å˜æ›´**ï¼š
   - ä»å›¾ç‰‡å‚æ•°ï¼ˆ`num_images`, `output_format`, `aspect_ratio`ï¼‰æ”¹ä¸ºè§†é¢‘å‚æ•°ï¼ˆ`num_frames`, `num_inference_steps`, `image_size`ï¼‰

3. **å“åº”æ ¼å¼å˜æ›´**ï¼š
   - å›¾ç‰‡ï¼š`{ images: [{ url: ... }] }`
   - è§†é¢‘ï¼š`{ video: { url: ... } }` æˆ– `{ video_url: ... }`

4. **å‰ç«¯æ˜¾ç¤ºå˜æ›´**ï¼š
   - ä» `<img>` æ ‡ç­¾æ”¹ä¸º `<video>` æ ‡ç­¾
   - æ·»åŠ è§†é¢‘æ’­æ”¾å±æ€§ï¼š`controls`, `autoPlay`, `loop`, `muted`, `playsInline`

5. **è¶…æ—¶æ—¶é—´è°ƒæ•´**ï¼š
   - å›¾ç‰‡ï¼š120 ç§’
   - è§†é¢‘ï¼š300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

## ä¿æŒå‘åå…¼å®¹

- æ‰€æœ‰è¿”å›æ•°æ®åŒæ—¶åŒ…å« `videoUrl` å’Œ `imageUrl`
- `imageUrl` å­—æ®µä¼šè¢«è®¾ç½®ä¸º `videoUrl` çš„å€¼
- å‰ç«¯ä»£ç ä¼˜å…ˆä½¿ç”¨ `videoUrl`ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ° `imageUrl`

## å½±å“çš„åŠŸèƒ½èŒƒå›´

âœ… **ä»…å½±å“**ï¼šæ•…äº‹ç»“æ„é€‰æ‹©é¡µé¢çš„ä¸‰ä¸ªæ•…äº‹ç¤ºä¾‹ç”Ÿæˆ
- å…¶ä»–åŠŸèƒ½ï¼ˆå¦‚è§’è‰²åˆ›å»ºã€å°é¢ç”Ÿæˆã€ä¿¡ä»¶ç›¸å…³ç­‰ï¼‰ä¿æŒä¸å˜
- æ‰€æœ‰å…¶ä»–ä½¿ç”¨ `/api/generate-image` çš„åœ°æ–¹ä¸å—å½±å“

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**ï¼šåˆšåˆš
**ä¿®æ”¹çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ—  lint é”™è¯¯


