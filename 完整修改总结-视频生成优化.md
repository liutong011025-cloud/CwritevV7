# 完整修改总结 - 视频生成优化（从6个视频到3个视频）

## 问题描述

**最初问题**：
- 三个结构生成了6个视频（每个结构生成了两个）
- 需要改为每个结构只生成一个视频
- 需要15秒视频时长
- 需要三个视频同时发送给fal.ai
- 生成完成后自动翻页

## 修改时间线

### 第一阶段：图片改为视频（初始实现）
### 第二阶段：修复重复生成问题（6个→3个）
### 第三阶段：优化并行生成和错误处理
### 第四阶段：切换模型（flux-schnell → hunyuan-video-v1.5）
### 第五阶段：修复freytag显示问题和时长优化

---

## 详细修改清单

### 1. 新建文件：`app/api/generate-video/route.ts`

**创建时间**：第一阶段
**最新修改**：第四、五阶段

**关键修改点**：

#### 第一阶段（初始创建）
- 使用 `flux-schnell` 模型
- 端点：`https://fal.run/fal-ai/flux-schnell`
- 参数：`num_frames: 25`（约1秒）

#### 第四阶段（模型切换）
- 改为 `hunyuan-video-v1.5` 模型
- 端点：`https://fal.run/fal-ai/hunyuan-video-v1.5/text-to-video`
- 参数：`num_frames: 121`（约4秒，30fps）

#### 第五阶段（时长优化）
- 参数：`num_frames: 121`（约5秒，24fps）
- 分辨率：`480p`
- 推理步数：`28`
- 超时时间：600秒（10分钟）

**当前代码关键部分**：
```typescript
const FAL_VIDEO_API_ENDPOINT = 'https://fal.run/fal-ai/hunyuan-video-v1.5/text-to-video'

const requestBody = {
  prompt: prompt.trim(),
  aspect_ratio: hunyuanAspectRatio, // 16:9 或 9:16
  resolution: '480p',
  num_frames: 121, // 最大121帧（约5秒，24fps）
  num_inference_steps: 28,
  enable_prompt_expansion: true,
}
```

---

### 2. 修改文件：`app/api/dify-structure-examples/route.ts`

**修改阶段**：第一、四阶段

#### 第一阶段修改
- 添加 `FAL_VIDEO_API_ENDPOINT` 常量
- 将单个故事生成时的图片生成改为视频生成
- 超时时间从120秒增加到300秒

#### 第四阶段修改
- 更新视频生成端点：`hunyuan-video-v1.5/text-to-video`
- 更新请求参数格式
- 更新响应解析逻辑

**关键修改**：
```typescript
// 修改前（图片生成）
const imageResponse = await fetch(FAL_API_ENDPOINT, {
  body: JSON.stringify({
    prompt: imagePrompt,
    num_images: 1,
    output_format: 'jpeg',
    aspect_ratio: '16:9',
    sync_mode: true,
  }),
})

// 修改后（视频生成）
const videoResponse = await fetch(FAL_VIDEO_API_ENDPOINT, {
  body: JSON.stringify({
    prompt: videoPrompt,
    aspect_ratio: "16:9",
    resolution: "480p",
    num_frames: 121,
    num_inference_steps: 28,
    enable_prompt_expansion: true,
  }),
})
```

---

### 3. 修改文件：`components/stages/story-structure.tsx`

**这是最重要的修改文件，经历了多次迭代**

#### 第一阶段：基础修改
- 接口定义添加 `videoUrl?` 字段
- 将图片生成调用改为视频生成调用
- 将 `<img>` 标签改为 `<video>` 标签

#### 第二阶段：修复重复生成问题（关键修改）

**问题**：每个结构生成了两个视频（共6个）

**原因分析**：
- 前端循环中为每个结构调用 `/api/generate-video`
- 后端 `dify-structure-examples` 在单个故事生成时也生成视频
- 导致重复生成

**解决方案**：
- 前端统一处理视频生成，后端只返回故事内容
- 使用 `Promise.all` 并行生成三个视频

**修改前（串行，可能重复）**：
```typescript
for (const { type, storyData } of structuresToProcess) {
  // 生成视频
  const videoResponse = await fetch("/api/generate-image", {
    // ...
  })
  // ...
}
```

**修改后（并行，每个只生成一次）**：
```typescript
// 并行发送三个视频生成请求
const videoPromises = structuresToProcess.map(async ({ type, storyData }) => {
  // 每个结构只生成一个视频
  const videoResponse = await fetch("/api/generate-video", {
    // ...
  })
  // ...
})

// 等待所有视频生成完成
const videoResults = await Promise.all(videoPromises)
generatedExamples.push(...videoResults)
```

#### 第三阶段：优化并行生成和错误处理

**修改**：
- 使用 `Promise.allSettled` 替代 `Promise.all`
- 确保即使一个失败，其他也能继续
- 添加详细的日志记录

**关键代码**：
```typescript
// 使用 Promise.allSettled 确保即使一个失败，其他也能继续
const videoResults = await Promise.allSettled(videoPromises)

videoResults.forEach((result, index) => {
  const structure = structuresToProcess[index]
  if (result.status === 'fulfilled') {
    generatedExamples.push(result.value)
  } else {
    // 即使失败，也添加占位符
    generatedExamples.push({
      structure_type: structure.type,
      story: structure.storyData?.story || "Example story",
      imageUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${structure.type}`,
      videoUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${structure.type}`,
    })
  }
})
```

#### 第四阶段：添加自动翻页

**修改**：
```typescript
setExamples(generatedExamples)

// 检查是否有视频生成成功
const hasVideos = generatedExamples.some(e => e.videoUrl && !e.videoUrl.includes('dicebear'))
if (hasVideos) {
  toast.success("Example stories and videos generated!")
  // 自动翻页到第一个结构
  setCurrentPage(0)
} else {
  toast.success("Example stories generated!")
}
```

#### 第五阶段：增强日志和错误处理

**修改**：
- 添加详细的日志记录（每个结构都有 `[type]` 标记）
- 添加视频加载状态监听
- 改进错误处理和调试信息

**关键代码**：
```typescript
console.log(`Generating video for ${type} structure...`)
console.log(`[${type}] Starting video generation...`)
console.log(`[${type}] Sending request to /api/generate-video`)
console.log(`Video response status for ${type}:`, videoResponse.status)
console.log(`Video URL for ${type}:`, videoUrl)
```

**视频显示改进**：
```typescript
{example.videoUrl && !example.videoUrl.includes('dicebear') ? (
  <video
    key={example.videoUrl}
    src={example.videoUrl}
    controls
    autoPlay
    loop
    muted
    playsInline
    onError={(e) => {
      console.error(`[${example.structure_type}] Video load error:`, e)
    }}
    onLoadedData={() => {
      console.log(`[${example.structure_type}] Video loaded successfully`)
    }}
    className="w-full h-auto max-h-[500px] min-h-[400px] object-contain"
  >
    您的浏览器不支持视频播放
  </video>
) : (
  <div className="w-full h-[400px] flex items-center justify-center bg-gray-100 rounded-lg">
    <p className="text-gray-500">视频生成中或加载失败</p>
  </div>
)}
```

---

## 修改统计

### 文件修改统计
- **新建文件**：1个（`app/api/generate-video/route.ts`）
- **修改文件**：2个（`app/api/dify-structure-examples/route.ts`, `components/stages/story-structure.tsx`）
- **文档文件**：2个（`FAL_AI_VIDEO_SETUP.md`, `代码修改总结.md`）

### 代码行数统计
- **新增代码**：约 200+ 行
- **修改代码**：约 150+ 行
- **删除代码**：约 50+ 行

---

## 核心问题解决

### ✅ 问题1：每个结构生成了两个视频（6个→3个）

**解决方案**：
- 前端统一处理视频生成
- 使用 `Promise.all` 并行生成，确保每个结构只生成一次
- 后端 `dify-structure-examples` 在 `generate_all=true` 时不再生成视频

### ✅ 问题2：三个视频同时发送给fal.ai

**解决方案**：
- 使用 `Promise.all` 或 `Promise.allSettled` 并行发送三个请求
- 所有请求同时发起，不等待前一个完成

### ✅ 问题3：生成完成后自动翻页

**解决方案**：
- 在所有视频生成完成后，检查是否有成功生成的视频
- 如果有，自动设置 `setCurrentPage(0)` 翻页到第一个结构

### ⚠️ 问题4：15秒视频时长

**限制**：
- Hunyuan Video V1.5 最大支持 121 帧
- 约 24fps，时长约 5 秒
- **无法实现15秒**（模型限制）

**当前设置**：
- `num_frames: 121`（最大帧数）
- 实际时长：约 5 秒

---

## 模型变更历史

1. **初始**：`flux-schnell`（快速，便宜）
2. **当前**：`hunyuan-video-v1.5`（质量更好，但最大5秒）

---

## 关键代码位置

### 视频生成逻辑
- **文件**：`components/stages/story-structure.tsx`
- **行数**：155-261行（并行生成逻辑）

### 视频API端点
- **文件**：`app/api/generate-video/route.ts`
- **行数**：1-161行（完整API实现）

### 视频显示组件
- **文件**：`components/stages/story-structure.tsx`
- **行数**：约 500-580行（视频标签和错误处理）

---

## 当前状态

✅ **已实现**：
- 每个结构只生成一个视频（3个视频）
- 三个视频并行发送给fal.ai
- 生成完成后自动翻页
- 详细的日志记录和错误处理
- 使用 Hunyuan Video V1.5 模型

⚠️ **限制**：
- 视频时长最大约5秒（无法实现15秒）
- 需要模型支持更长视频才能实现15秒

---

## 测试建议

1. **检查控制台日志**：
   - 查找 `[freytag]`, `[threeAct]`, `[fichtean]` 标记
   - 确认每个结构只生成一次
   - 检查是否有错误

2. **检查视频数量**：
   - 应该只有3个视频（每个结构一个）
   - 不应该有重复

3. **检查自动翻页**：
   - 视频生成完成后应该自动翻页到第一个结构

---

**最后更新时间**：刚刚
**修改状态**：✅ 已完成


